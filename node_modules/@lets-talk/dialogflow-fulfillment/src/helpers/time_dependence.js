const { OpeningHours } = require('@stadtkatalog/openinghours');
const loggerHelper = require("./logger");

const logger = loggerHelper.getLogger("FulfillmentTimeDependence");

function evaluateTimeDependenceParams(params) {
  const currentDate = new Date();
  paramsCopy = JSON.parse(JSON.stringify(params));
  if (params.hasOwnProperty("group_id")) {
    paramsCopy.group_id = evaluateTimeDependenceGroupId(params.group_id, currentDate);
  }
  if (params.hasOwnProperty("inquiry_id")) {
    paramsCopy.inquiry_id = evaluateTimeDependenceGroupId(params.inquiry_id, currentDate);
  }
  logger.info("Parameters with evaluated time dependence", paramsCopy);
  return paramsCopy
}


function evaluateTimeDependenceGroupId(groupId, currentDate) {
  if (groupId.hasOwnProperty("time_dependence")) {
    const settings = groupId.time_dependence;
    const timeEvaluator = new OpeningHours(settings.deviating_times, settings.timezone);
    const shouldDeviate = timeEvaluator.isOpenAt(currentDate);
    return (shouldDeviate) ? settings.deviating_value : settings.default;
  } else {
    return groupId
  }
}

exports.evaluateTimeDependenceParams = evaluateTimeDependenceParams;
